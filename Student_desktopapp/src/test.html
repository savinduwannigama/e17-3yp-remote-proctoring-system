<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        div {
            --volume: 0%;
            position: relative;
            width: 200px;
            height: 20px;
            margin: 50px;
            background-color: #DDD;
        }
        
        div::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: var(--volume);
            background-color: green;
            transition: width 100ms linear;
        }
        
        button {
            margin-left: 50px;
        }
        
        h3 {
            margin: 20px;
            font-family: sans-serif;
        }
    </style>
</head>

<body>
    <h3><b>NOTE:</b> This is not accurate on stackoverflow, since microphone use is not permitted. It's a simulation instead.</h3>
    <div id="volume-visualizer"></div>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <script>
        (async() => {
            let volumeCallback = null;
            let volumeInterval = null;
            const volumeVisualizer = document.getElementById('volume-visualizer');
            const startButton = document.getElementById('start');
            const stopButton = document.getElementById('stop');
            // Initialize
            try {
                const audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true
                    }
                });
                const audioContext = new AudioContext();
                const audioSource = audioContext.createMediaStreamSource(audioStream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                analyser.minDecibels = -127;
                analyser.maxDecibels = 0;
                analyser.smoothingTimeConstant = 0.4;
                audioSource.connect(analyser);
                const volumes = new Uint8Array(analyser.frequencyBinCount);
                volumeCallback = () => {
                    analyser.getByteFrequencyData(volumes);
                    let volumeSum = 0;
                    for (const volume of volumes)
                        volumeSum += volume;
                    const averageVolume = volumeSum / volumes.length;
                    // Value range: 127 = analyser.maxDecibels - analyser.minDecibels;
                    volumeVisualizer.style.setProperty('--volume', (averageVolume * 100 / 127) + '%');
                };
            } catch (e) {
                console.error('Failed to initialize volume visualizer, simulating instead...', e);
                // Simulation
                //TODO remove in production!
                let lastVolume = 50;
                volumeCallback = () => {
                    const volume = Math.min(Math.max(Math.random() * 100, 0.8 * lastVolume), 1.2 * lastVolume);
                    lastVolume = volume;
                    volumeVisualizer.style.setProperty('--volume', volume + '%');
                };
            }
            // Use
            startButton.addEventListener('click', () => {
                // Updating every 100ms (should be same as CSS transition speed)
                if (volumeCallback !== null && volumeInterval === null)
                    volumeInterval = setInterval(volumeCallback, 100);
            });
            stopButton.addEventListener('click', () => {
                if (volumeInterval !== null) {
                    clearInterval(volumeInterval);
                    volumeInterval = null;
                }
            });
        })();
    </script>
</body>

</html>